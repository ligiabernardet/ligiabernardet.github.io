
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>10. Tips for Adding a New Scheme &#8212; CCPP Technical  documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="11. Acronyms" href="Acronyms.html" />
    <link rel="prev" title="9. Building and Running Host Models" href="BuildingRunningHostModels.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Acronyms.html" title="11. Acronyms"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="BuildingRunningHostModels.html" title="9. Building and Running Host Models"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">CCPP Technical  documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tips-for-adding-a-new-scheme">
<span id="addnewschemes"></span><h1>10. Tips for Adding a New Scheme<a class="headerlink" href="#tips-for-adding-a-new-scheme" title="Permalink to this headline">¶</a></h1>
<p>This chapter contains a brief description on how to add a new scheme to the <em>CCPP-Physics</em> pool.</p>
<ul>
<li><p>Identify the variables required for the new scheme and check if they are already available for use in the CCPP by checking the metadata information in <code class="docutils literal notranslate"><span class="pre">GFS_typedefs.meta</span></code> or by perusing file <code class="docutils literal notranslate"><span class="pre">ccpp-framework/doc/DevelopersGuide/CCPP_VARIABLES_{FV3,SCM}.pdf</span></code> generated by <code class="docutils literal notranslate"><span class="pre">ccpp_prebuild.py</span></code>.</p>
<blockquote>
<div><ul class="simple">
<li><p>If the variables are already available, they can be invoked in the scheme’s metadata file and one can skip the rest of this subsection. If the variable required is not available, consider if it can be calculated from the existing variables in the CCPP. If so, an interstitial scheme (such as <code class="docutils literal notranslate"><span class="pre">scheme_pre</span></code>; see more in <a class="reference internal" href="CompliantPhysicsParams.html#compliantphysparams"><span class="std std-numref">Chapter 2</span></a>) can be created to calculate the variable. However, the variable must be defined but not initialized in the host model as the memory for this variable must be allocated on the host model side.  Instructions for how to add variables to the host model side is described in <a class="reference internal" href="HostSideCoding.html#host-side-coding"><span class="std std-numref">Chapter 6</span></a>.</p></li>
<li><p>If new namelist variables need to be added, the <code class="docutils literal notranslate"><span class="pre">GFS_control_type</span></code> DDT should be used. In this case, it is also important to modify the namelist file <code class="docutils literal notranslate"><span class="pre">input.nml</span></code> to include the new variable.</p></li>
<li><p>It is important to note that not all data types are persistent in memory. Most variables in the interstitial data type are reset (to zero or other initial values) at the beginning of a physics group and do not persist from one set to another or from one group to another. The diagnostic data type is periodically reset because it is used to accumulate variables for given time intervals.  However, there is a small subset of interstitial variables that are set at creation time and are not reset; these are typically dimensions used in other interstitial variables.</p></li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the value of a variable must be remembered from one call to the next, it should not be in the interstitial or diagnostic data types.</p>
</div>
</div></blockquote>
<ul class="simple">
<li><p>If information from the previous timestep is needed, it is important to identify if the host model readily provides this information. For example, in the Model for Prediction Across Scales (MPAS), variables containing the values of several quantities in the preceding timesteps are available. When that is not the case, as in the UFS Atmosphere, interstitial schemes are needed to compute these variables. As an example, the reader is referred to the GF convective scheme, which makes use of interstitials to obtain the previous timestep information.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Examine scheme-specific and suite interstitials to see what needs to be replaced/changed; then check existing scheme interstitial and determine what needs to replicated. Identify if your new scheme requires additional interstitial code that must be run before or after the scheme and that cannot be part of the scheme itself, for example because of dependencies on other schemes and/or the order the scheme is run in the SDF.</p></li>
<li><p>Follow the guidelines outlined in <a class="reference internal" href="CompliantPhysicsParams.html#compliantphysparams"><span class="std std-numref">Chapter 2</span></a> to make your scheme CCPP-compliant. Make sure to use an uppercase suffix <code class="docutils literal notranslate"><span class="pre">.F90</span></code> to enable C preprocessing.</p></li>
<li><p>Locate the CCPP <em>prebuild</em> configuration files for the target host model, for example:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NEMSfv3gfs/ccpp/config/ccpp_prebuild_config.py</span></code> for the UFS Atmosphere</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gmtb-scm/ccpp/config/ccpp_prebuild_config.py</span></code> for the SCM</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Add the new scheme to the Python dictionary in <code class="docutils literal notranslate"><span class="pre">ccpp_prebuild_config.py</span></code> using the same path
as the existing schemes:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">SCHEME_FILES = [ ...</span>
<span class="go">’../some_relative_path/existing_scheme.F90’,</span>
<span class="go">’../some_relative_path/new_scheme.F90’,</span>
<span class="go">...]</span>
</pre></div>
</div>
</li>
<li><p>If the new scheme uses optional arguments, add information on which ones to use further down in the configuration file. See existing entries and documentation in the configuration file for the possible options:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">OPTIONAL_ARGUMENTS = {</span>
<span class="go">        ’SCHEME_NAME’ : {</span>
<span class="go">        ’SCHEME_NAME_run’ : [</span>
<span class="gp">        #</span> list of all optional arguments in use <span class="k">for</span> this
<span class="gp">        #</span> model, by standard_name <span class="o">]</span>,
<span class="gp">        #</span> instead of list <span class="o">[</span>...<span class="o">]</span>, can also say ’all’ or ’none’
<span class="go">        },</span>
<span class="go">    }</span>
</pre></div>
</div>
</li>
<li><p>Place new scheme in the same location as existing schemes in the CCPP directory structure, e.g., <code class="docutils literal notranslate"><span class="pre">../some_relative_path/new_scheme.F90</span></code>.</p></li>
<li><p>Edit the SDF and add the new scheme at the place it should be run. SDFs are located in</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NEMSfv3gfs/ccpp/suites</span></code> for the UFS Atmosphere</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gmtb-scm/ccpp/suites</span></code> for the SCM</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Before running, check for consistency between the namelist and the SDF. There is no default consistency check between the SDF and the namelist unless the developer adds one. Errors may result in segmentation faults in running something you did not intend to run if the arrays are not allocated.</p></li>
<li><p>Test and debug the new scheme:</p>
<blockquote>
<div><ul class="simple">
<li><p>Typical problems include segment faults related to variables and array allocation.</p></li>
<li><p>Make sure SDF and namelist are compatible. Inconsistencies may result in segmentation faults because arrays are not allocated or in unintended scheme(s) being executed.</p></li>
<li><p>A scheme called GFS_debug (<code class="docutils literal notranslate"><span class="pre">GFS_debug.F90</span></code>) may be added to the SDF where needed to print state variables and interstitial variables. If needed, edit the scheme beforehand to add new variables that need to be printed.</p></li>
<li><p>Check <em>prebuild</em> script for success/failure and associated messages.</p></li>
<li><p>Compile code in DEBUG mode, run through debugger if necessary (gdb, Allinea DDT, totalview, …).  See <a class="reference internal" href="BuildingRunningHostModels.html#buildingrunninghostmodels"><span class="std std-numref">Chapter 9</span></a> for information on debugging.</p></li>
<li><p>Use memory check utilities such as valgrind.</p></li>
<li><p>Double-check the metadata file associated with your scheme to make sure that all information, including standard names and units, correspond to the correct local variables.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Done. Note that no further modifications of the build system are required, since the <em>CCPP-Framework</em> will autogenerate the necessary makefiles that allow the host model to compile the scheme.</p></li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="BuildingRunningHostModels.html"
                        title="previous chapter">9. Building and Running Host Models</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Acronyms.html"
                        title="next chapter">11. Acronyms</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/AddingNewSchemes.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Acronyms.html" title="11. Acronyms"
             >next</a> |</li>
        <li class="right" >
          <a href="BuildingRunningHostModels.html" title="9. Building and Running Host Models"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">CCPP Technical  documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019 .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>