
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>5. Autogenerated Physics Caps &#8212; CCPP Technical  documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Host Side Coding" href="HostSideCoding.html" />
    <link rel="prev" title="4. Constructing Suites" href="ConstructingSuite.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="HostSideCoding.html" title="6. Host Side Coding"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ConstructingSuite.html" title="4. Constructing Suites"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">CCPP Technical  documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="autogenerated-physics-caps">
<span id="autogenphyscaps"></span><h1>5. Autogenerated Physics <em>Caps</em><a class="headerlink" href="#autogenerated-physics-caps" title="Permalink to this headline">¶</a></h1>
<p>The connection between the host model and the physics schemes through the CCPP-Framework
is realized with <em>caps</em> on both sides as illustrated in <a class="reference internal" href="Overview.html#ccpp-arch-host"><span class="std std-numref">Figure 1.1</span></a>.
The CCPP <em>prebuild</em> script discussed in <a class="reference internal" href="ConfigBuildOptions.html#configbuildoptions"><span class="std std-numref">Chapter 3</span></a>
generates the <em>caps</em> that connect the physics schemes to the CCPP-Framework,
and a large fraction of code that can be included in the host model <em>cap</em>. The host model
<em>cap</em> connects the framework (Physics Driver) to the host model and must be created
manually incorporating the autogenerated code. This chapter describes the physics <em>caps</em>,
while the host model <em>caps</em> are described in <a class="reference internal" href="HostSideCoding.html#host-side-coding"><span class="std std-numref">Chapter 6</span></a>. Note that the dynamic build,
which can be used with the SCM and with the UFS Atmosphere, produces individual
physics scheme <em>caps</em>, while the static build (for UFS Atmosphere only) produces group
and suite <em>caps</em>. The physics <em>caps</em> autogenerated by <code class="docutils literal notranslate"><span class="pre">ccpp_prebuild.py</span></code> reside in the directory
defined by the <code class="docutils literal notranslate"><span class="pre">CAPS_DIR</span></code> variable (see example in <a class="reference internal" href="CCPPPreBuild.html#ccpp-prebuild-example"><span class="std std-ref">Listing 8.1</span></a>).</p>
<div class="section" id="dynamic-build-caps">
<span id="dynamicbuildcaps"></span><h2>5.1. Dynamic Build <em>Caps</em><a class="headerlink" href="#dynamic-build-caps" title="Permalink to this headline">¶</a></h2>
<p>With the dynamic build, the CCPP-Framework and physics are dynamically linked to the executable
to allow maximum runtime flexibility. A <em>cap</em> is generated using the metadata associated with
the arguments of each scheme and the metadata associated with the variables provided by the
host model (see left side of <a class="reference internal" href="ConfigBuildOptions.html#ccpp-dynamic-build"><span class="std std-numref">Figure 3.2</span></a>). These metadata variables
are described in the <code class="docutils literal notranslate"><span class="pre">.meta</span></code> files associated with the host model and the schemes.
The CCPP <em>prebuild</em> step for the dynamic build performs the following tasks:</p>
<ul class="simple">
<li><p>Checks requested vs provided variables by <code class="docutils literal notranslate"><span class="pre">standard_name</span></code>.</p></li>
<li><p>Checks units, rank, type.</p></li>
<li><p>Creates Fortran code that adds pointers to the host model variables and stores them in the
ccpp-data structure (<code class="docutils literal notranslate"><span class="pre">ccpp_fields_*.inc</span></code>). A hash table that is part of cdata is populated with
key = standard_name of a variable and value = location of that variable in memory (i.e. a c-pointer).</p></li>
<li><p>Creates one <em>cap</em> per physics scheme.</p></li>
<li><p>Populates makefiles with schemes and <em>caps</em>.</p></li>
</ul>
<p>The <em>prebuild</em> step will produce the following files for the UFS Atmosphere model:</p>
<ul class="simple">
<li><p>List of variables provided by host model and required by physics:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/framework/doc/DevelopersGuide/CCPP_VARIABLES_FV3.tex</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Makefile snippets that contain all <em>caps</em> to be compiled:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/physics/CCPP_CAPS.{cmake,mk}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Makefile snippets that contain all schemes (and their dependencies) to be compiled:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/physics/CCPP_SCHEMES.{cmake,mk}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>List of variables provided by host model:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/physics/CCPP_VARIABLES_FV3.html</span>
</pre></div>
</div>
<ul class="simple">
<li><p>One <em>cap</em> per physics scheme:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/physics/*_cap.F90</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*.inc</span></code> files that contain <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">use</span></code> and <code class="docutils literal notranslate"><span class="pre">ccpp_field_add</span></code> statements that populate the ccpp data type (<code class="docutils literal notranslate"><span class="pre">cdata</span></code>) with the necessary information on where (in memory) to find required variables:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">FV3/atmos_cubed_sphere/driver/fvGFS/ccpp_modules_{fast,slow}_physics.inc</span>
<span class="go">FV3/atmos_cubed_sphere/driver/fvGFS/ccpp_fields_{fast,slow}_physics.inc</span>
<span class="go">FV3/ipd/ccpp_modules_{fast,slow}_physics.inc</span>
<span class="go">FV3/ipd/ccpp_fields_{fast,slow}_physics.inc</span>
</pre></div>
</div>
<p>The variables added to <code class="docutils literal notranslate"><span class="pre">*_fast_physics.inc</span></code> do not use <code class="docutils literal notranslate"><span class="pre">GFS_typedefs.F90</span></code> or <code class="docutils literal notranslate"><span class="pre">CCPP_data.F90</span></code>.</p>
<ul class="simple">
<li><p>Autogenerated code to include in host model <em>caps</em> (called TARGET FILES) via CPP (C preprocessor) directives:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">FV3/ipd/IPD_CCPP_driver.F90 for slow physics</span>
<span class="go">FV3/atmos_cubed_sphere/driver/fvGFS/atmosphere.F90 for fast physics</span>
</pre></div>
</div>
<p>For each <em>cap</em>, <code class="docutils literal notranslate"><span class="pre">ccpp_prebuild.py</span></code> generates “use” statements based on the host model template.
Only the public <em>caps</em> (<code class="docutils literal notranslate"><span class="pre">init</span></code>, <code class="docutils literal notranslate"><span class="pre">run</span></code> and <code class="docutils literal notranslate"><span class="pre">finalize</span></code>) are exposed (see code example below).
Each <em>cap</em> consists of a module containing three functions. For example, <code class="docutils literal notranslate"><span class="pre">scheme_pre_cap.F90</span></code>
would contain the functions <code class="docutils literal notranslate"><span class="pre">scheme_pre_init_cap</span></code>, <code class="docutils literal notranslate"><span class="pre">scheme_pre_run_cap</span></code> and <code class="docutils literal notranslate"><span class="pre">scheme_pre_finalize_cap</span></code>, which perform the functions below.</p>
<ul class="simple">
<li><p>Declare data types <code class="docutils literal notranslate"><span class="pre">cptr</span></code>, <code class="docutils literal notranslate"><span class="pre">cdims</span></code> and <code class="docutils literal notranslate"><span class="pre">ckind</span></code>.</p></li>
<li><p>Create a pointer to the Fortran data type <code class="docutils literal notranslate"><span class="pre">cdata</span></code>.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">ccpp_field_get</span></code> for each variable in the metadata file for the scheme and pull data from the <code class="docutils literal notranslate"><span class="pre">cdata</span></code> structure.</p></li>
</ul>
<p>The index defined in each call speeds up memory access by avoiding a binary search,
since variables are no longer searched by name; the order of the data in <code class="docutils literal notranslate"><span class="pre">cdata</span></code> are known.</p>
<ul class="simple">
<li><p>Call the corresponding scheme entry-point at the end with an explicit argument list.</p></li>
</ul>
<p>For example, the autogenerated scheme <em>cap</em> for <code class="docutils literal notranslate"><span class="pre">rrtmg_lw_pre_cap.F90</span></code> is shown in
<a class="reference internal" href="#rrtmg-lw-pre-cap"><span class="std std-ref">Listing 5.1</span></a>.</p>
<div class="highlight-fortran notranslate" id="rrtmg-lw-pre-cap"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">rrtmg_lw_pre_cap</span>
 <span class="k">use</span><span class="p">,</span> <span class="k">intrinsic</span> <span class="kd">::</span> <span class="nb">iso_c_binding</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="nb">c_f_pointer</span><span class="p">,</span> <span class="p">&amp;</span>
                   <span class="kt">c_ptr</span><span class="p">,</span> <span class="kt">c_int32_t</span>
<span class="kt"> </span><span class="k">use</span>            <span class="kd">::</span> <span class="n">ccpp_types</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">ccpp_t</span><span class="p">,</span> <span class="n">CCPP_GENERIC_KIND</span>
 <span class="k">use</span>            <span class="kd">::</span> <span class="n">ccpp_fields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ccpp_field_get</span>
 <span class="k">use</span>            <span class="kd">::</span> <span class="n">ccpp_errors</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ccpp_error</span><span class="p">,</span> <span class="n">ccpp_debug</span>
 <span class="k">use</span>            <span class="kd">::</span> <span class="n">rrtmg_lw_pre</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">rrtmg_lw_pre_run</span><span class="p">,</span> <span class="p">&amp;</span>
                   <span class="n">rrtmg_lw_pre_init</span><span class="p">,</span><span class="n">rrtmg_lw_pre_finalize</span>
 <span class="c">! Other modules required, e.g. type definitions</span>
 <span class="k">use </span><span class="n">GFS_typedefs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">GFS_control_type</span><span class="p">,</span><span class="n">GFS_grid_type</span><span class="p">,</span> <span class="p">&amp;</span>
                         <span class="n">GFS_sfcprop_type</span><span class="p">,</span><span class="n">GFS_radtend_type</span>
 <span class="k">use </span><span class="n">machine</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">kind_phys</span>
 <span class="k">implicit none</span>
<span class="k"> private</span>
<span class="k"> public</span> <span class="kd">::</span> <span class="n">rrtmg_lw_pre_run_cap</span><span class="p">,</span><span class="n">rrtmg_lw_pre_init_cap</span><span class="p">,</span> <span class="p">&amp;</span>
           <span class="n">rrtmg_lw_pre_finalize_cap</span>
 <span class="k">contains</span>
<span class="k"> function </span><span class="n">rrtmg_lw_pre_init_cap</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
     <span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">ierr</span>
     <span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ptr</span>
     <span class="k">type</span><span class="p">(</span><span class="n">ccpp_t</span><span class="p">),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">cdata</span>
     <span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">cptr</span>
     <span class="kt">integer</span><span class="p">,</span> <span class="k">allocatable</span>            <span class="kd">::</span> <span class="n">cdims</span><span class="p">(:)</span>
     <span class="kt">integer</span>                         <span class="kd">::</span> <span class="n">ckind</span>
     <span class="n">ierr</span> <span class="o">=</span> <span class="mi">0</span>
     <span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
     <span class="k">call </span><span class="n">rrtmg_lw_pre_init</span><span class="p">()</span>
 <span class="k">end function </span><span class="n">rrtmg_lw_pre_init_cap</span>

 <span class="k">function </span><span class="n">rrtmg_lw_pre_run_cap</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
     <span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">ierr</span>
     <span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ptr</span>
     <span class="k">type</span><span class="p">(</span><span class="n">ccpp_t</span><span class="p">),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">cdata</span>
     <span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">cptr</span>
     <span class="kt">integer</span><span class="p">,</span> <span class="k">allocatable</span>            <span class="kd">::</span> <span class="n">cdims</span><span class="p">(:)</span>
     <span class="kt">integer</span>                         <span class="kd">::</span> <span class="n">ckind</span>
     <span class="k">type</span><span class="p">(</span><span class="n">GFS_control_type</span><span class="p">),</span> <span class="k">pointer</span>     <span class="kd">::</span> <span class="n">Model</span>
     <span class="k">type</span><span class="p">(</span><span class="n">GFS_grid_type</span><span class="p">),</span> <span class="k">pointer</span>     <span class="kd">::</span> <span class="n">Grid</span>
     <span class="k">type</span><span class="p">(</span><span class="n">GFS_sfcprop_type</span><span class="p">),</span> <span class="k">pointer</span>     <span class="kd">::</span> <span class="n">Sfcprop</span>
     <span class="k">type</span><span class="p">(</span><span class="n">GFS_radtend_type</span><span class="p">),</span> <span class="k">pointer</span>     <span class="kd">::</span> <span class="n">Radtend</span>
     <span class="kt">integer</span><span class="p">,</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">im</span>
     <span class="kt">real</span><span class="p">(</span><span class="n">kind_phys</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">tsfg</span><span class="p">(:)</span>
     <span class="kt">real</span><span class="p">(</span><span class="n">kind_phys</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">tsfa</span><span class="p">(:)</span>
     <span class="n">ierr</span> <span class="o">=</span> <span class="mi">0</span>
     <span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
     <span class="k">call </span><span class="n">ccpp_field_get</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span><span class="s1">&#39;GFS_control_type_instance&#39;</span><span class="p">,</span><span class="n">cptr</span><span class="p">,&amp;</span>
          <span class="n">ierr</span><span class="o">=</span><span class="n">ierr</span><span class="p">,</span> <span class="nb">kind</span><span class="o">=</span><span class="n">ckind</span><span class="p">,</span> <span class="nb">index</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
     <span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>
     <span class="k">call </span><span class="n">ccpp_field_get</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span><span class="s1">&#39;GFS_grid_type_instance&#39;</span><span class="p">,</span><span class="n">cptr</span><span class="p">,&amp;</span>
          <span class="n">ierr</span><span class="o">=</span><span class="n">ierr</span><span class="p">,</span> <span class="nb">kind</span><span class="o">=</span><span class="n">ckind</span><span class="p">,</span> <span class="nb">index</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
     <span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="n">Grid</span><span class="p">)</span>
     <span class="k">call </span><span class="n">ccpp_field_get</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="s1">&#39;GFS_sfcprop_type_instance&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
          <span class="n">cptr</span><span class="p">,</span> <span class="n">ierr</span><span class="o">=</span><span class="n">ierr</span><span class="p">,</span> <span class="nb">kind</span><span class="o">=</span><span class="n">ckind</span><span class="p">,</span> <span class="nb">index</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
     <span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="n">Sfcprop</span><span class="p">)</span>
     <span class="k">call </span><span class="n">ccpp_field_get</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="s1">&#39;GFS_radtend_type_instance&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
          <span class="n">cptr</span><span class="p">,</span> <span class="n">ierr</span><span class="o">=</span><span class="n">ierr</span><span class="p">,</span> <span class="nb">kind</span><span class="o">=</span><span class="n">ckind</span><span class="p">,</span> <span class="nb">index</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
     <span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="n">Radtend</span><span class="p">)</span>
     <span class="k">call </span><span class="n">ccpp_field_get</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="s1">&#39;horizontal_loop_extent&#39;</span><span class="p">,</span> <span class="n">im</span><span class="p">,&amp;</span>
          <span class="n">ierr</span><span class="o">=</span><span class="n">ierr</span><span class="p">,</span> <span class="nb">kind</span><span class="o">=</span><span class="n">ckind</span><span class="p">,</span> <span class="nb">index</span><span class="o">=</span><span class="mi">390</span><span class="p">)</span>
     <span class="k">call </span><span class="n">ccpp_field_get</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="p">&amp;</span>
          <span class="s1">&#39;surface_ground_temperature_for_radiation&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
           <span class="n">tsfg</span><span class="p">,</span> <span class="n">ierr</span><span class="o">=</span><span class="n">ierr</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">cdims</span><span class="p">,</span> <span class="nb">kind</span><span class="o">=</span><span class="n">ckind</span><span class="p">,</span> <span class="nb">index</span><span class="o">=</span><span class="mi">770</span><span class="p">)</span>
     <span class="k">deallocate</span><span class="p">(</span><span class="n">cdims</span><span class="p">)</span>
     <span class="k">call </span><span class="n">ccpp_field_get</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="p">&amp;</span>
          <span class="s1">&#39;surface_air_temperature_for_radiation&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
           <span class="n">tsfa</span><span class="p">,</span> <span class="n">ierr</span><span class="o">=</span><span class="n">ierr</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">cdims</span><span class="p">,</span> <span class="nb">kind</span><span class="o">=</span><span class="n">ckind</span><span class="p">,</span> <span class="nb">index</span><span class="o">=</span><span class="mi">724</span><span class="p">)</span>
     <span class="k">deallocate</span><span class="p">(</span><span class="n">cdims</span><span class="p">)</span>
     <span class="k">call </span><span class="n">rrtmg_lw_pre_run</span><span class="p">(</span><span class="n">Model</span><span class="o">=</span><span class="n">Model</span><span class="p">,</span><span class="n">Grid</span><span class="o">=</span><span class="n">Grid</span><span class="p">,</span> <span class="p">&amp;</span>
          <span class="n">Sfcprop</span><span class="o">=</span><span class="n">Sfcprop</span><span class="p">,</span><span class="n">Radtend</span><span class="o">=</span><span class="n">Radtend</span><span class="p">,</span><span class="n">im</span><span class="o">=</span><span class="n">im</span><span class="p">,</span> <span class="p">&amp;</span>
          <span class="n">tsfg</span><span class="o">=</span><span class="n">tsfg</span><span class="p">,</span><span class="n">tsfa</span><span class="o">=</span><span class="n">tsfa</span><span class="p">,</span> <span class="p">&amp;</span>
          <span class="n">errmsg</span><span class="o">=</span><span class="n">cdata</span><span class="p">%</span><span class="n">errmsg</span><span class="p">,</span><span class="n">errflg</span><span class="o">=</span><span class="n">cdata</span><span class="p">%</span><span class="n">errflg</span><span class="p">)</span>
     <span class="n">ierr</span><span class="o">=</span><span class="n">cdata</span><span class="p">%</span><span class="n">errflg</span>
 <span class="k">end function </span><span class="n">rrtmg_lw_pre_run_cap</span>
 <span class="k">function </span><span class="n">rrtmg_lw_pre_finalize_cap</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
     <span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">ierr</span>
     <span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ptr</span>
     <span class="k">type</span><span class="p">(</span><span class="n">ccpp_t</span><span class="p">),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">cdata</span>
     <span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">cptr</span>
     <span class="kt">integer</span><span class="p">,</span> <span class="k">allocatable</span>            <span class="kd">::</span> <span class="n">cdims</span><span class="p">(:)</span>
     <span class="kt">integer</span>                         <span class="kd">::</span> <span class="n">ckind</span>
     <span class="n">ierr</span> <span class="o">=</span> <span class="mi">0</span>
     <span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">cdata</span><span class="p">)</span>
     <span class="k">call </span><span class="n">rrtmg_lw_pre_finalize</span><span class="p">()</span>
 <span class="k">end function </span><span class="n">rrtmg_lw_pre_finalize_cap</span>
<span class="k">end module </span><span class="n">rrtmg_lw_pre_cap</span>
</pre></div>
</div>
<p><em>Listing 5.1: Condensed version of the autogenerated scheme cap</em> <code class="docutils literal notranslate"><span class="pre">rrtmg_lw_pre_cap.F90</span></code> <em>for the dynamic build. Note the calls to</em> <code class="docutils literal notranslate"><span class="pre">ccpp_field_get</span></code> <em>for each variable.</em></p>
<p>The fields accessed from <code class="docutils literal notranslate"><span class="pre">cdata</span></code> are determined by the metadata for the arguments of the scheme. In this example,
<code class="docutils literal notranslate"><span class="pre">rrtmg_lw_pre_init</span></code> and <code class="docutils literal notranslate"><span class="pre">rrtmg_lw_pre_finalize</span></code> are empty subroutines, i.e. they have no arguments passed in or out,
no metadata section in the <code class="docutils literal notranslate"><span class="pre">.meta</span></code> file, and no calls to <code class="docutils literal notranslate"><span class="pre">ccpp_field_get</span></code>. However, <code class="docutils literal notranslate"><span class="pre">rrtmg_lw_pre_run</span></code>
has a metadata section in file <code class="docutils literal notranslate"><span class="pre">rrtmg_lw_pre.meta</span></code>, so <code class="docutils literal notranslate"><span class="pre">ccpp_field_get</span></code>
is called for each variable described in the metadata section and the value put into the call to <code class="docutils literal notranslate"><span class="pre">rrtmg_lw_pre_run</span></code>.</p>
</div>
<div class="section" id="static-build-caps">
<h2>5.2. Static Build Caps<a class="headerlink" href="#static-build-caps" title="Permalink to this headline">¶</a></h2>
<p>With a static build, the CCPP-Framework and physics are statically linked to the executable. This allows the best
performance and efficient memory use. Similar to the dynamic build, the static build requires metadata provided
by the host model and variables requested from the physics scheme. Unlike a dynamic build where all variables are
kept and pulled multiple times for various parameterizations, a static build only keeps variables for specified suites,
and therefore requires one or more SDFs (see left side of <a class="reference internal" href="ConfigBuildOptions.html#ccpp-static-build"><span class="std std-numref">Figure 3.3</span></a>) as arguments to the <code class="docutils literal notranslate"><span class="pre">ccpp_prebuild.py</span></code> script.
The CCPP <em>prebuild</em> step for the static build performs the tasks below.</p>
<ul class="simple">
<li><p>Check requested vs provided variables by <code class="docutils literal notranslate"><span class="pre">standard_name</span></code>.</p></li>
<li><p>Check units, rank, type.</p></li>
<li><p>Filter unused schemes and variables.</p></li>
<li><p>Create Fortran code for the static Application Programming Interface (API) that replaces the dynamic API (CCPP-Framework). The hash table used by the dynamic build to store variables in memory is left empty.</p></li>
<li><p>Create <em>caps</em> for groups and suite(s).</p></li>
<li><p>Populate makefiles with schemes and <em>caps</em>.</p></li>
</ul>
<p>The <em>prebuild</em> step for the static build will produce the following files for the UFS Atmosphere:</p>
<ul class="simple">
<li><p>List of variables provided by host model and required by physics:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/framework/doc/DevelopersGuide/CCPP_VARIABLES_FV3.tex</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Makefile snippets that contain all <em>caps</em> to be compiled:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/physics/CCPP_CAPS.{cmake,mk}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Makefile snippets that contain all schemes to be compiled:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/physics/CCPP_SCHEMES.{cmake,mk}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>List of variables provided by host model:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/physics/CCPP_VARIABLES_FV3.html</span>
</pre></div>
</div>
<ul class="simple">
<li><p>One <em>cap</em> per physics group (fast_physics, physics, radiation, time_vary, stochastic, …) for each suite:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/physics/ccpp_{suite_name}_{group_name}_cap.F90</span>
</pre></div>
</div>
<ul class="simple">
<li><p><em>Cap</em> for each suite:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccpp/physics/ccpp_{suite_name}_cap.F90</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Autogenerated API for static build that replaces the dynamic API (aka CCPP-Framework), the interface is identical between the two APIs:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">FV3/gfsphysics/CCPP_layer/ccpp_static_api.F90</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Same TARGET FILES as for the dynamic build</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ccpp_static_api.F90</span></code> replaces the entire dynamic CCPP-Framework with an equivalent interface,
which contains subroutines <code class="docutils literal notranslate"><span class="pre">ccpp_physics_init</span></code>, <code class="docutils literal notranslate"><span class="pre">ccpp_physics_run</span></code> and <code class="docutils literal notranslate"><span class="pre">ccpp_physics_finalize</span></code>.
Each subroutine uses a <code class="docutils literal notranslate"><span class="pre">suite_name</span></code> and an optional argument, <code class="docutils literal notranslate"><span class="pre">group_name</span></code>, to call the groups
of a specified suite (e.g. <code class="docutils literal notranslate"><span class="pre">fast_physics</span></code>, <code class="docutils literal notranslate"><span class="pre">physics</span></code>, <code class="docutils literal notranslate"><span class="pre">time_vary</span></code>, <code class="docutils literal notranslate"><span class="pre">radiation</span></code>, <code class="docutils literal notranslate"><span class="pre">stochastic</span></code>, etc.),
or to call the entire suite. For example, <code class="docutils literal notranslate"><span class="pre">ccpp_static_api.F90</span></code> would contain module <code class="docutils literal notranslate"><span class="pre">ccpp_static_api</span></code>
with subroutines <code class="docutils literal notranslate"><span class="pre">ccpp_physics_{init,</span> <span class="pre">run,</span> <span class="pre">finalize}</span></code>. The subroutine <code class="docutils literal notranslate"><span class="pre">ccpp_physics_init</span></code> from the
autogenerated code using suites <code class="docutils literal notranslate"><span class="pre">FV3_GFS_v15</span></code> and <code class="docutils literal notranslate"><span class="pre">FV3_CPT_v0</span></code> is shown in <a class="reference internal" href="#ccpp-physics-init"><span class="std std-ref">Listing 5.2</span></a>.</p>
<div class="highlight-fortran notranslate" id="ccpp-physics-init"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">ccpp_physics_init</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="n">suite_name</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
  <span class="k">use </span><span class="n">ccpp_types</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ccpp_t</span>
  <span class="k">implicit none</span>
<span class="k">  type</span><span class="p">(</span><span class="n">ccpp_t</span><span class="p">),</span>               <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cdata</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span>           <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">suite_name</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">group_name</span>
  <span class="kt">integer</span><span class="p">,</span>                    <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">ierr</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">suite_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;FV3_GFS_v15&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">    if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span> <span class="k">then</span>
<span class="k">      if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;fast_physics&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_fast_physics_init_cap</span><span class="p">(</span><span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">,</span> <span class="n">CCPP_interstitial</span><span class="o">=</span><span class="n">CCPP_interstitial</span><span class="p">)</span>
      <span class="k">else if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;time_vary&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_time_vary_init_cap</span><span class="p">(</span><span class="n">GFS_Interstitial</span><span class="o">=</span><span class="n">GFS_Interstitial</span><span class="p">,</span> <span class="p">&amp;</span>
               <span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">,</span><span class="n">GFS_Data</span><span class="o">=</span><span class="n">GFS_Data</span><span class="p">,</span> <span class="n">GFS_Control</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">)</span>
      <span class="k">else if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;radiation&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_radiation_init_cap</span><span class="p">()</span>
      <span class="k">else if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;physics&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_physics_init_cap</span><span class="p">(</span><span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">,</span> <span class="n">GFS_Control</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">)</span>
      <span class="k">else if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;stochastics&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_stochastics_init_cap</span><span class="p">()</span>
      <span class="k">else</span>
<span class="k">        write</span><span class="p">(</span><span class="n">cdata</span><span class="p">%</span><span class="n">errmsg</span><span class="p">,</span> <span class="s1">&#39;(*(a))&#39;</span><span class="p">)</span> <span class="s2">&quot;Group &quot;</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span> <span class="o">//</span> <span class="s2">&quot; not found&quot;</span>
        <span class="n">ierr</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">end if</span>
<span class="k">    else</span>
<span class="k">      </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_init_cap</span><span class="p">(</span><span class="n">GFS_Interstitial</span><span class="o">=</span><span class="n">GFS_Interstitial</span><span class="p">,</span> <span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">,</span><span class="n">GFS_Control</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">,</span> <span class="p">&amp;</span>
            <span class="n">GFS_Data</span><span class="o">=</span><span class="n">GFS_Data</span><span class="p">,</span> <span class="n">CCPP_interstitial</span><span class="o">=</span><span class="n">CCPP_interstitial</span><span class="p">)</span>
    <span class="k">end if</span>
<span class="k">  else if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">suite_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;FV3_CPT_v0&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">    if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">group_name</span><span class="p">))</span> <span class="k">then</span>
<span class="k">      if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;time_vary&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_CPT_v0_time_vary_init_cap</span><span class="p">(</span><span class="n">GFS_Interstitial</span><span class="o">=</span><span class="n">GFS_Interstitial</span><span class="p">,</span> <span class="p">&amp;</span>
               <span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">,</span><span class="n">GFS_Data</span><span class="o">=</span><span class="n">GFS_Data</span><span class="p">,</span> <span class="n">GFS_Control</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">)</span>
      <span class="k">else if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;radiation&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_CPT_v0_radiation_init_cap</span><span class="p">()</span>
      <span class="k">else if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;physics&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_CPT_v0_physics_init_cap</span><span class="p">(</span><span class="n">con_hfus</span><span class="o">=</span><span class="n">con_hfus</span><span class="p">,</span> <span class="p">&amp;</span>
                  <span class="n">GFS_Control</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">,</span><span class="n">con_hvap</span><span class="o">=</span><span class="n">con_hvap</span><span class="p">,</span> <span class="p">&amp;</span>
                  <span class="n">con_rd</span><span class="o">=</span><span class="n">con_rd</span><span class="p">,</span><span class="n">con_rv</span><span class="o">=</span><span class="n">con_rv</span><span class="p">,</span><span class="n">con_g</span><span class="o">=</span><span class="n">con_g</span><span class="p">,</span> <span class="p">&amp;</span>
                  <span class="n">con_ttp</span><span class="o">=</span><span class="n">con_ttp</span><span class="p">,</span><span class="n">con_cp</span><span class="o">=</span><span class="n">con_cp</span><span class="p">,</span><span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">)</span>
      <span class="k">else if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;stochastics&quot;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_CPT_v0_stochastics_init_cap</span><span class="p">()</span>
      <span class="k">else</span>
<span class="k">        write</span><span class="p">(</span><span class="n">cdata</span><span class="p">%</span><span class="n">errmsg</span><span class="p">,</span> <span class="s1">&#39;(*(a))&#39;</span><span class="p">)</span> <span class="s2">&quot;Group &quot;</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span> <span class="o">//</span> <span class="s2">&quot; not found&quot;</span>
        <span class="n">ierr</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">end if</span>
<span class="k">    else</span>
<span class="k">      </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_CPT_v0_init_cap</span><span class="p">(</span><span class="n">con_g</span><span class="o">=</span><span class="n">con_g</span><span class="p">,</span> <span class="n">GFS_Data</span><span class="o">=</span><span class="n">GFS_Data</span><span class="p">,</span><span class="n">GFS_Control</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">,</span> <span class="p">&amp;</span>
             <span class="n">con_hvap</span><span class="o">=</span><span class="n">con_hvap</span><span class="p">,</span><span class="n">GFS_Interstitial</span><span class="o">=</span><span class="n">GFS_Interstitial</span><span class="p">,</span> <span class="n">con_rd</span><span class="o">=</span><span class="n">con_rd</span><span class="p">,</span><span class="n">con_rv</span><span class="o">=</span><span class="n">con_rv</span><span class="p">,</span> <span class="p">&amp;</span>
             <span class="n">con_hfus</span><span class="o">=</span><span class="n">con_hfus</span><span class="p">,</span> <span class="n">con_ttp</span><span class="o">=</span><span class="n">con_ttp</span><span class="p">,</span><span class="n">con_cp</span><span class="o">=</span><span class="n">con_cp</span><span class="p">,</span><span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">)</span>
    <span class="k">end if</span>
<span class="k">  else</span>
<span class="k">    write</span><span class="p">(</span><span class="n">cdata</span><span class="p">%</span><span class="n">errmsg</span><span class="p">,</span><span class="s1">&#39;(*(a))&#39;</span><span class="p">),</span> <span class="s1">&#39;Invalid suite &#39;</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="n">suite_name</span><span class="p">)</span>
    <span class="n">ierr</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">end if</span>
<span class="k">  </span><span class="n">cdata</span><span class="p">%</span><span class="n">errflg</span> <span class="o">=</span> <span class="n">ierr</span>
<span class="k">end subroutine </span><span class="n">ccpp_physics_init</span>
</pre></div>
</div>
<p><em>Listing 5.2: Code sample of subroutine</em> <code class="docutils literal notranslate"><span class="pre">ccpp_physics_init</span></code> <em>contained in the autogenerated file</em>
<code class="docutils literal notranslate"><span class="pre">ccpp_static_api.F90</span></code> <em>for the multi-suite static build. This cap was generated using suites</em>
<code class="docutils literal notranslate"><span class="pre">FV3_GFS_v15</span></code> <em>and</em> <code class="docutils literal notranslate"><span class="pre">FV3_CPT_v0</span></code>. <em>Examples of the highlighted functions are shown below in</em>
<a class="reference internal" href="#fv3-gfs-v15-physics"><span class="std std-ref">Listing 5.3</span></a> <em>and</em> <a class="reference internal" href="#fv3-gfs-v15-init-cap"><span class="std std-ref">Listing 5.4</span></a>.</p>
<p>Note that if group_name is set, specified groups (i.e. <code class="docutils literal notranslate"><span class="pre">FV3_GFS_v15_physics_init_cap</span></code>) are called for the
specified <code class="docutils literal notranslate"><span class="pre">suite_name</span></code>. These functions are defined in <code class="docutils literal notranslate"><span class="pre">ccpp_{suite_name}_{group_name}_cap.F90</span></code>, in this
case <code class="docutils literal notranslate"><span class="pre">ccpp_FV3_GFS_v15_physics_cap.F90</span></code>. For example:</p>
<div class="highlight-fortran notranslate" id="fv3-gfs-v15-physics"><div class="highlight"><pre><span></span><span class="k">function </span><span class="n">FV3_GFS_v15_physics_init_cap</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span><span class="n">GFS_Control</span><span class="p">)&amp;</span>
        <span class="k">result</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
   <span class="k">use </span><span class="n">ccpp_types</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ccpp_t</span>
   <span class="k">use </span><span class="n">GFS_typedefs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">GFS_control_type</span>
   <span class="k">implicit none</span>
<span class="k">   </span><span class="kt">integer</span>                     <span class="kd">::</span> <span class="n">ierr</span>
   <span class="k">type</span><span class="p">(</span><span class="n">ccpp_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cdata</span>
   <span class="k">type</span><span class="p">(</span><span class="n">GFS_control_type</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">GFS_Control</span>
   <span class="n">ierr</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span> <span class="k">return</span>
<span class="k">   call </span><span class="n">lsm_noah_init</span><span class="p">(</span><span class="n">me</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">me</span><span class="p">,</span><span class="n">isot</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">isot</span><span class="p">,&amp;</span>
         <span class="n">ivegsrc</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">ivegsrc</span><span class="p">,</span><span class="n">nlunit</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">nlunit</span><span class="p">,</span> <span class="p">&amp;</span>
         <span class="n">errmsg</span><span class="o">=</span><span class="n">cdata</span><span class="p">%</span><span class="n">errmsg</span><span class="p">,</span><span class="n">errflg</span><span class="o">=</span><span class="n">cdata</span><span class="p">%</span><span class="n">errflg</span><span class="p">)</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">cdata</span><span class="p">%</span><span class="n">errflg</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">     write</span><span class="p">(</span><span class="n">cdata</span><span class="p">%</span><span class="n">errmsg</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span> <span class="s2">&quot;An error occured in lsm_noah_init&quot;</span>
     <span class="n">ierr</span><span class="o">=</span><span class="n">cdata</span><span class="p">%</span><span class="n">errflg</span>
     <span class="k">return</span>
<span class="k">   end if</span>
<span class="k">   call </span><span class="n">gfdl_cloud_microphys_init</span><span class="p">(</span><span class="n">me</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">me</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="n">master</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">master</span><span class="p">,</span><span class="n">nlunit</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">nlunit</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="n">input_nml_file</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">input_nml_file</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="n">logunit</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">logunit</span><span class="p">,</span><span class="n">fn_nml</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">fn_nml</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="n">imp_physics</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">imp_physics</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="n">imp_physics_gfdl</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">imp_physics_gfdl</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="n">do_shoc</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">%</span><span class="n">do_shoc</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="n">errmsg</span><span class="o">=</span><span class="n">cdata</span><span class="p">%</span><span class="n">errmsg</span><span class="p">,</span><span class="n">errflg</span><span class="o">=</span><span class="n">cdata</span><span class="p">%</span><span class="n">errflg</span><span class="p">)</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">cdata</span><span class="p">%</span><span class="n">errflg</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">     write</span><span class="p">(</span><span class="n">cdata</span><span class="p">%</span><span class="n">errmsg</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span> <span class="s2">&quot;An error occured in &amp;</span>
<span class="s2">           gfdl_cloud_microphys_init&quot;</span>
     <span class="n">ierr</span><span class="o">=</span><span class="n">cdata</span><span class="p">%</span><span class="n">errflg</span>
     <span class="k">return</span>
<span class="k">   end if</span>
<span class="k">   </span><span class="n">initialized</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="k">end function </span><span class="n">FV3_GFS_v15_physics_init_cap</span>
</pre></div>
</div>
<p><em>Listing 5.3: The</em> <code class="docutils literal notranslate"><span class="pre">FV3_GFS_v15_physics_init_cap</span></code> <em>contained in the autogenerated file</em>
<code class="docutils literal notranslate"><span class="pre">ccpp_FV3_GFS_v15_physics_cap.F90</span></code> <em>showing calls to the</em> <code class="docutils literal notranslate"><span class="pre">lsm_noah_init</span></code> <em>, and</em>
<code class="docutils literal notranslate"><span class="pre">gfdl_cloud_microphys_init</span></code> <em>subroutines for the static build for suite ‘FV3_GFS_v15’ and group ‘physics’.</em></p>
<p>If the group_name is not specified for a specified suite_name, the suite is called from the autogenerated
<code class="docutils literal notranslate"><span class="pre">ccpp_static_api.F90</span></code>, which calls the <code class="docutils literal notranslate"><span class="pre">init</span></code>, <code class="docutils literal notranslate"><span class="pre">run</span></code> and <code class="docutils literal notranslate"><span class="pre">finalize</span></code> routines for each group.
<a class="reference internal" href="#fv3-gfs-v15-init-cap"><span class="std std-ref">Listing 5.4</span></a> is an example of <code class="docutils literal notranslate"><span class="pre">FV3_GFS_v15_init_cap</span></code>.</p>
<div class="highlight-fortran notranslate" id="fv3-gfs-v15-init-cap"><div class="highlight"><pre><span></span><span class="k">function </span><span class="n">FV3_GFS_v15_init_cap</span><span class="p">(</span><span class="n">GFS_Interstitial</span><span class="p">,</span> <span class="p">&amp;</span>
  <span class="n">cdata</span><span class="p">,</span><span class="n">GFS_Control</span><span class="p">,</span><span class="n">GFS_Data</span><span class="p">,</span><span class="n">CCPP_interstitial</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
  <span class="k">use </span><span class="n">GFS_typedefs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">GFS_interstitial_type</span>
  <span class="k">use </span><span class="n">ccpp_types</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ccpp_t</span>
  <span class="k">use </span><span class="n">GFS_typedefs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">GFS_control_type</span>
  <span class="k">use </span><span class="n">GFS_typedefs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">GFS_data_type</span>
  <span class="k">use </span><span class="n">CCPP_typedefs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">CCPP_interstitial_type</span>

  <span class="k">implicit none</span>

<span class="k">  </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">ierr</span>
  <span class="k">type</span><span class="p">(</span><span class="n">GFS_interstitial_type</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">GFS_Interstitial</span><span class="p">(:)</span>
  <span class="k">type</span><span class="p">(</span><span class="n">ccpp_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cdata</span>
  <span class="k">type</span><span class="p">(</span><span class="n">GFS_control_type</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">GFS_Control</span>
  <span class="k">type</span><span class="p">(</span><span class="n">GFS_data_type</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">GFS_Data</span><span class="p">(:)</span>
  <span class="k">type</span><span class="p">(</span><span class="n">CCPP_interstitial_type</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">CCPP_interstitial</span>

  <span class="n">ierr</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_fast_physics_init_cap</span><span class="p">(</span><span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">,</span> <span class="n">CCPP_interstitial</span><span class="o">=</span><span class="n">CCPP_interstitial</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span>

<span class="k">  </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_time_vary_init_cap</span> <span class="p">(</span><span class="n">GFS_Interstitial</span><span class="o">=</span><span class="n">GFS_Interstitial</span><span class="p">,</span><span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">,</span> <span class="p">&amp;</span>
         <span class="n">GFS_Data</span><span class="o">=</span><span class="n">GFS_Data</span><span class="p">,</span><span class="n">GFS_Control</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span>

<span class="k">  </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_radiation_init_cap</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span>
<span class="k">  </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_physics_init_cap</span><span class="p">(</span><span class="n">cdata</span><span class="o">=</span><span class="n">cdata</span><span class="p">,</span> <span class="p">&amp;</span>
      <span class="n">GFS_Control</span><span class="o">=</span><span class="n">GFS_Control</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span>

<span class="k">  </span><span class="n">ierr</span> <span class="o">=</span> <span class="n">FV3_GFS_v15_stochastics_init_cap</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span>
<span class="k">end function </span><span class="n">FV3_GFS_v15_init_cap</span>
</pre></div>
</div>
<p><em>Listing 5.4: Condensed version of the</em> <code class="docutils literal notranslate"><span class="pre">FV3_GFS_v15_init_cap</span></code> <em>function contained in the autogenerated
file</em> <code class="docutils literal notranslate"><span class="pre">ccpp_FV3_GFS_v15_cap.F90</span></code> <em>showing calls to the group caps</em>
<code class="docutils literal notranslate"><span class="pre">FV3_GFS_v15_fast_physics_init_cap</span></code>, <code class="docutils literal notranslate"><span class="pre">FV3_GFS_v15_time_vary_init_cap</span></code> <em>, etc.
for the static build where a group name is not specified.</em></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5. Autogenerated Physics <em>Caps</em></a><ul>
<li><a class="reference internal" href="#dynamic-build-caps">5.1. Dynamic Build <em>Caps</em></a></li>
<li><a class="reference internal" href="#static-build-caps">5.2. Static Build Caps</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="ConstructingSuite.html"
                        title="previous chapter">4. Constructing Suites</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="HostSideCoding.html"
                        title="next chapter">6. Host Side Coding</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/AutoGenPhysCaps.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="HostSideCoding.html" title="6. Host Side Coding"
             >next</a> |</li>
        <li class="right" >
          <a href="ConstructingSuite.html" title="4. Constructing Suites"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">CCPP Technical  documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019 .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>